<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Debug Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      h1,
      h2,
      h3 {
        color: #333;
      }
      .debug-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
      }
      .endpoint {
        margin-bottom: 20px;
      }
      button {
        padding: 8px 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      pre {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        max-height: 400px;
        border: 1px solid #ddd;
      }
      .status {
        font-weight: bold;
        margin: 10px 0;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: 1px solid #ddd;
        background-color: #f1f1f1;
        margin-right: 5px;
      }
      .tab.active {
        background-color: #fff;
        border-bottom: 1px solid #fff;
      }
      .tab-content {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
        margin-top: -1px;
      }
      .tab-content.active {
        display: block;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <h1>JaJongTee API Debug Page</h1>
    <p>
      Use this page to test and debug the API endpoints for the login log
      functionality.
    </p>

    <div class="tabs">
      <div class="tab active" onclick="openTab(event, 'api-tests')">
        API Tests
      </div>
      <div class="tab" onclick="openTab(event, 'database-info')">
        Database Info
      </div>
      <div class="tab" onclick="openTab(event, 'error-logs')">Error Logs</div>
    </div>

    <div id="api-tests" class="tab-content active">
      <div class="debug-section">
        <h2>API Endpoints</h2>

        <div class="endpoint">
          <h3>GET /api/login-logs</h3>
          <button onclick="testLoginLogs()">Test Endpoint</button>
          <button onclick="testLoginLogsWithParams()">
            Test With Parameters
          </button>
          <div class="status" id="login-logs-status"></div>
          <pre id="login-logs-result">Results will appear here...</pre>
        </div>

        <div class="endpoint">
          <h3>GET /api/active-users-count</h3>
          <button onclick="testActiveUsersCount()">Test Endpoint</button>
          <div class="status" id="active-users-status"></div>
          <pre id="active-users-result">Results will appear here...</pre>
        </div>

        <div class="endpoint">
          <h3>GET /api/total-logins-today</h3>
          <button onclick="testTotalLoginsToday()">Test Endpoint</button>
          <div class="status" id="total-logins-status"></div>
          <pre id="total-logins-result">Results will appear here...</pre>
        </div>
      </div>
    </div>

    <div id="database-info" class="tab-content">
      <div class="debug-section">
        <h2>Database Information</h2>
        <button onclick="getDatabaseInfo()">Get Database Info</button>
        <div id="database-tables">
          <h3>Tables</h3>
          <div id="tables-list"></div>
        </div>
      </div>
    </div>

    <div id="error-logs" class="tab-content">
      <div class="debug-section">
        <h2>Error Logs</h2>
        <p>Recent errors will be displayed here.</p>
        <div id="error-log-container">
          <p>No errors logged yet.</p>
        </div>
      </div>
    </div>

    <script>
      // Error logging
      const errorLog = [];

      function logError(source, error) {
        const timestamp = new Date().toISOString();
        const logEntry = {
          timestamp,
          source,
          error: error.toString(),
          details: error.stack || "No stack trace available",
        };
        errorLog.unshift(logEntry); // Add to beginning of array
        updateErrorLogDisplay();
        console.error(`[${timestamp}] ${source}:`, error);
      }

      function updateErrorLogDisplay() {
        const container = document.getElementById("error-log-container");
        if (errorLog.length === 0) {
          container.innerHTML = "<p>No errors logged yet.</p>";
          return;
        }

        let html = "<ul>";
        errorLog.forEach((entry) => {
          html += `
                    <li>
                        <strong>${entry.timestamp}</strong> - ${entry.source}
                        <p>${entry.error}</p>
                        <pre>${entry.details}</pre>
                    </li>
                `;
        });
        html += "</ul>";
        container.innerHTML = html;
      }

      // Tab functionality
      function openTab(evt, tabName) {
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
          tabContents[i].classList.remove("active");
        }

        const tabs = document.getElementsByClassName("tab");
        for (let i = 0; i < tabs.length; i++) {
          tabs[i].classList.remove("active");
        }

        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
      }

      // API testing functions
      async function testEndpoint(url, statusElementId, resultElementId) {
        const statusElement = document.getElementById(statusElementId);
        const resultElement = document.getElementById(resultElementId);

        statusElement.textContent = "Testing...";
        statusElement.className = "status";
        resultElement.textContent = "Fetching data...";

        try {
          const startTime = new Date().getTime();
          const response = await fetch(url);
          const endTime = new Date().getTime();
          const responseTime = endTime - startTime;

          if (response.ok) {
            const data = await response.json();
            statusElement.textContent = `Success (${responseTime}ms)`;
            statusElement.className = "status success";
            resultElement.textContent = JSON.stringify(data, null, 2);
          } else {
            const errorText = await response.text();
            statusElement.textContent = `Error: ${response.status} (${responseTime}ms)`;
            statusElement.className = "status error";
            resultElement.textContent = errorText;
            logError(
              `API Test: ${url}`,
              new Error(`HTTP ${response.status}: ${errorText}`),
            );
          }
        } catch (error) {
          statusElement.textContent = `Exception: ${error.message}`;
          statusElement.className = "status error";
          resultElement.textContent = error.stack || error.toString();
          logError(`API Test: ${url}`, error);
        }
      }

      function testLoginLogs() {
        testEndpoint(
          "/api/login-logs",
          "login-logs-status",
          "login-logs-result",
        );
      }

      function testLoginLogsWithParams() {
        const params = new URLSearchParams({
          page: 1,
          limit: 5,
          search: "",
          sortBy: "loginDate",
          sortDirection: "desc",
        });
        testEndpoint(
          `/api/login-logs?${params.toString()}`,
          "login-logs-status",
          "login-logs-result",
        );
      }

      function testActiveUsersCount() {
        testEndpoint(
          "/api/active-users-count",
          "active-users-status",
          "active-users-result",
        );
      }

      function testTotalLoginsToday() {
        testEndpoint(
          "/api/total-logins-today",
          "total-logins-status",
          "total-logins-result",
        );
      }

      // Database info functions
      async function getDatabaseInfo() {
        try {
          const response = await fetch("/api/debug/tables");
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          displayDatabaseInfo(data);
        } catch (error) {
          logError("Database Info", error);
          document.getElementById("tables-list").innerHTML = `
                    <div class="error">Error fetching database info: ${error.message}</div>
                `;
        }
      }

      function displayDatabaseInfo(data) {
        const tablesContainer = document.getElementById("tables-list");
        let html = "";

        if (data.tables && data.tables.length > 0) {
          data.tables.forEach((table) => {
            html += `
                        <div class="table-info">
                            <h4>${table}</h4>
                            ${renderTableData(data.sampleData[table])}
                        </div>
                    `;
          });
        } else {
          html = "<p>No tables found in the database.</p>";
        }

        tablesContainer.innerHTML = html;
      }

      function renderTableData(data) {
        if (!data || data.length === 0) {
          return "<p>No data available for this table.</p>";
        }

        if (data.error) {
          return `<p class="error">Error: ${data.error}</p>`;
        }

        const columns = Object.keys(data[0]);
        let html = "<table>";

        // Table header
        html += "<tr>";
        columns.forEach((column) => {
          html += `<th>${column}</th>`;
        });
        html += "</tr>";

        // Table rows
        data.forEach((row) => {
          html += "<tr>";
          columns.forEach((column) => {
            html += `<td>${row[column] !== null ? row[column] : "NULL"}</td>`;
          });
          html += "</tr>";
        });

        html += "</table>";
        return html;
      }
    </script>
  </body>
</html>
